<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ºå®šæ—¶é—´è¯¾ç¨‹å‰ç«¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å›ºå®šæ—¶é—´è¯¾ç¨‹å‰ç«¯æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ•°æ®å‡†å¤‡</h2>
        <p>å‡†å¤‡æµ‹è¯•ç”¨çš„å›ºå®šæ—¶é—´è¯¾ç¨‹æ•°æ®</p>
        <button class="test-button" onclick="prepareTestData()">å‡†å¤‡æµ‹è¯•æ•°æ®</button>
        <div id="testDataResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ•°æ®åºåˆ—åŒ–</h2>
        <p>æµ‹è¯•æ•°æ®åœ¨JSONåºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„æ ¼å¼</p>
        <button class="test-button" onclick="testDataSerialization()">æµ‹è¯•åºåˆ—åŒ–</button>
        <div id="serializationResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•APIè°ƒç”¨</h2>
        <p>æµ‹è¯•å®é™…çš„APIè°ƒç”¨ï¼ˆéœ€è¦åç«¯æœåŠ¡è¿è¡Œï¼‰</p>
        <button class="test-button" onclick="testApiCall()">æµ‹è¯•APIè°ƒç”¨</button>
        <div id="apiResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ•°æ®è½¬æ¢</h2>
        <p>æµ‹è¯•å„ç§æ•°æ®è½¬æ¢æ–¹æ³•</p>
        <button class="test-button" onclick="testDataTransformation()">æµ‹è¯•æ•°æ®è½¬æ¢</button>
        <div id="transformationResult" class="result"></div>
    </div>

    <script>
        // æµ‹è¯•æ•°æ®
        let testData = null;
        
        function prepareTestData() {
            testData = {
                name: 'å‰ç«¯æµ‹è¯•æ’è¯¾è§„åˆ™',
                description: 'æµ‹è¯•å›ºå®šæ—¶é—´è¯¾ç¨‹æ•°æ®æ ¼å¼',
                schoolType: 'primary',
                academicYear: '2025-2026',
                semester: 1,
                timeRules: {
                    dailyPeriods: 7,
                    workingDays: [1, 2, 3, 4, 5],
                    periodDuration: 40,
                    breakDuration: 10,
                    lunchBreakStart: 4,
                    lunchBreakDuration: 90,
                    morningPeriods: [1, 2, 3],
                    afternoonPeriods: [5, 6, 7, 4],
                    forbiddenSlots: []
                },
                teacherConstraints: {
                    maxDailyHours: 6,
                    maxContinuousHours: 2,
                    minRestBetweenCourses: 1,
                    avoidFridayAfternoon: false,
                    respectTeacherPreferences: true,
                    allowCrossGradeTeaching: true,
                    rotationStrategy: {
                        enableRotation: true,
                        rotationMode: 'round_robin',
                        roundCompletion: true,
                        minIntervalBetweenClasses: 1,
                        maxConsecutiveClasses: 2,
                        rotationOrder: 'alphabetical',
                        customRotationOrder: []
                    }
                },
                roomConstraints: {
                    respectCapacityLimits: true,
                    allowRoomSharing: false,
                    preferFixedClassrooms: true,
                    specialRoomPriority: 'preferred'
                },
                courseArrangementRules: {
                    allowContinuousCourses: false,
                    maxContinuousHours: 2,
                    distributionPolicy: 'balanced',
                    avoidFirstLastPeriod: [],
                    coreSubjectPriority: true,
                    labCoursePreference: 'afternoon',
                    subjectSpecificRules: [],
                    enableSubjectConstraints: true,
                    defaultSubjectInterval: 1,
                    coreSubjectStrategy: {
                        enableCoreSubjectStrategy: true,
                        coreSubjects: ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­'],
                        distributionMode: 'daily',
                        maxDailyOccurrences: 2,
                        minDaysPerWeek: 5,
                        avoidConsecutiveDays: true,
                        preferredTimeSlots: [2, 3, 5, 6, 4, 1, 7],
                        avoidTimeSlots: [8],
                        maxConcentration: 1,
                        balanceWeight: 100,
                        enforceEvenDistribution: true
                    },
                    fixedTimeCourses: {
                        enabled: true,
                        courses: [
                            {
                                type: 'class-meeting',
                                dayOfWeek: 1,
                                period: 1,
                                weekType: 'all',
                                startWeek: 1,
                                endWeek: 20,
                                notes: 'ç­ä¸»ä»»ä¸»æŒç­ä¼š'
                            }
                        ],
                        priority: true,
                        allowOverride: false,
                        conflictStrategy: 'strict'
                    }
                },
                conflictResolutionRules: {
                    teacherConflictResolution: 'strict',
                    roomConflictResolution: 'warn',
                    classConflictResolution: 'warn',
                    allowOverride: false,
                    priorityOrder: ['teacher', 'room', 'time']
                },
                isDefault: false,
                isActive: true
            };
            
            document.getElementById('testDataResult').innerHTML = 
                '<div class="success">âœ… æµ‹è¯•æ•°æ®å‡†å¤‡å®Œæˆ</div>' +
                '<strong>fixedTimeCourses ç±»å‹:</strong> ' + typeof testData.courseArrangementRules.fixedTimeCourses + '<br>' +
                '<strong>courses ç±»å‹:</strong> ' + typeof testData.courseArrangementRules.fixedTimeCourses.courses + '<br>' +
                '<strong>courses é•¿åº¦:</strong> ' + testData.courseArrangementRules.fixedTimeCourses.courses.length;
        }
        
        function testDataSerialization() {
            if (!testData) {
                document.getElementById('serializationResult').innerHTML = 
                    '<div class="error">âŒ è¯·å…ˆå‡†å¤‡æµ‹è¯•æ•°æ®</div>';
                return;
            }
            
            try {
                // æµ‹è¯•JSONåºåˆ—åŒ–
                const jsonString = JSON.stringify(testData, null, 2);
                const parsedData = JSON.parse(jsonString);
                
                // æ£€æŸ¥åºåˆ—åŒ–åçš„æ•°æ®
                const fixedTimeCourses = parsedData.courseArrangementRules.fixedTimeCourses;
                const courses = fixedTimeCourses.courses;
                
                document.getElementById('serializationResult').innerHTML = 
                    '<div class="success">âœ… JSONåºåˆ—åŒ–æµ‹è¯•å®Œæˆ</div>' +
                    '<strong>åºåˆ—åŒ–å fixedTimeCourses ç±»å‹:</strong> ' + typeof fixedTimeCourses + '<br>' +
                    '<strong>åºåˆ—åŒ–å courses ç±»å‹:</strong> ' + typeof courses + '<br>' +
                    '<strong>åºåˆ—åŒ–å courses é•¿åº¦:</strong> ' + courses.length + '<br>' +
                    '<strong>åºåˆ—åŒ–å courses æ˜¯å¦ä¸ºæ•°ç»„:</strong> ' + Array.isArray(courses) + '<br>' +
                    '<strong>åºåˆ—åŒ–åæ•°æ®ç¤ºä¾‹:</strong><br>' +
                    '<pre>' + JSON.stringify(fixedTimeCourses, null, 2) + '</pre>';
                    
            } catch (error) {
                document.getElementById('serializationResult').innerHTML = 
                    '<div class="error">âŒ åºåˆ—åŒ–æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        async function testApiCall() {
            if (!testData) {
                document.getElementById('apiResult').innerHTML = 
                    '<div class="error">âŒ è¯·å…ˆå‡†å¤‡æµ‹è¯•æ•°æ®</div>';
                return;
            }
            
            try {
                document.getElementById('apiResult').innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...';
                
                const response = await fetch('http://localhost:3001/api/scheduling-rules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResult').innerHTML = 
                        '<div class="success">âœ… APIè°ƒç”¨æˆåŠŸ</div>' +
                        '<strong>å“åº”çŠ¶æ€:</strong> ' + response.status + '<br>' +
                        '<strong>å“åº”æ•°æ®:</strong><br>' +
                        '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                } else {
                    document.getElementById('apiResult').innerHTML = 
                        '<div class="error">âŒ APIè°ƒç”¨å¤±è´¥</div>' +
                        '<strong>çŠ¶æ€ç :</strong> ' + response.status + '<br>' +
                        '<strong>é”™è¯¯ä¿¡æ¯:</strong> ' + JSON.stringify(result, null, 2);
                }
                
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    '<div class="error">âŒ APIè°ƒç”¨å¼‚å¸¸: ' + error.message + '</div>';
            }
        }
        
        function testDataTransformation() {
            if (!testData) {
                document.getElementById('transformationResult').innerHTML = 
                    '<div class="error">âŒ è¯·å…ˆå‡†å¤‡æµ‹è¯•æ•°æ®</div>';
                return;
            }
            
            try {
                // æµ‹è¯•å„ç§æ•°æ®è½¬æ¢æ–¹æ³•
                const transformations = [];
                
                // 1. ç›´æ¥èµ‹å€¼
                let data1 = { ...testData };
                transformations.push({
                    method: 'ç›´æ¥èµ‹å€¼ (spread operator)',
                    fixedTimeCoursesType: typeof data1.courseArrangementRules.fixedTimeCourses,
                    coursesType: typeof data1.courseArrangementRules.fixedTimeCourses.courses,
                    coursesIsArray: Array.isArray(data1.courseArrangementRules.fixedTimeCourses.courses)
                });
                
                // 2. JSONåºåˆ—åŒ–åè§£æ
                let data2 = JSON.parse(JSON.stringify(testData));
                transformations.push({
                    method: 'JSONåºåˆ—åŒ–åè§£æ',
                    fixedTimeCoursesType: typeof data2.courseArrangementRules.fixedTimeCourses,
                    coursesType: typeof data2.courseArrangementRules.fixedTimeCourses.courses,
                    coursesIsArray: Array.isArray(data2.courseArrangementRules.fixedTimeCourses.courses)
                });
                
                // 3. ç»“æ„åŒ–å…‹éš†ï¼ˆå¦‚æœæ”¯æŒï¼‰
                let data3 = null;
                if (typeof structuredClone === 'function') {
                    data3 = structuredClone(testData);
                    transformations.push({
                        method: 'structuredClone',
                        fixedTimeCoursesType: typeof data3.courseArrangementRules.fixedTimeCourses,
                        coursesType: typeof data3.courseArrangementRules.fixedTimeCourses.courses,
                        coursesIsArray: Array.isArray(data3.courseArrangementRules.fixedTimeCourses.courses)
                    });
                }
                
                // 4. æ‰‹åŠ¨æ·±æ‹·è´
                let data4 = JSON.parse(JSON.stringify(testData));
                transformations.push({
                    method: 'æ‰‹åŠ¨æ·±æ‹·è´ (JSON.parse + JSON.stringify)',
                    fixedTimeCoursesType: typeof data4.courseArrangementRules.fixedTimeCourses,
                    coursesType: typeof data4.courseArrangementRules.fixedTimeCourses.courses,
                    coursesIsArray: Array.isArray(data4.courseArrangementRules.fixedTimeCourses.courses)
                });
                
                // æ˜¾ç¤ºç»“æœ
                let resultHtml = '<div class="success">âœ… æ•°æ®è½¬æ¢æµ‹è¯•å®Œæˆ</div>';
                resultHtml += '<table border="1" style="border-collapse: collapse; width: 100%;">';
                resultHtml += '<tr><th>è½¬æ¢æ–¹æ³•</th><th>fixedTimeCoursesç±»å‹</th><th>coursesç±»å‹</th><th>coursesæ˜¯å¦ä¸ºæ•°ç»„</th></tr>';
                
                transformations.forEach(t => {
                    resultHtml += `<tr>
                        <td>${t.method}</td>
                        <td>${t.fixedTimeCoursesType}</td>
                        <td>${t.coursesType}</td>
                        <td>${t.coursesIsArray}</td>
                    </tr>`;
                });
                
                resultHtml += '</table>';
                
                document.getElementById('transformationResult').innerHTML = resultHtml;
                
            } catch (error) {
                document.getElementById('transformationResult').innerHTML = 
                    '<div class="error">âŒ æ•°æ®è½¬æ¢æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>
