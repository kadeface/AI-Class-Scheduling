<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ•°æ®æµè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .data-display { background: #e9ecef; padding: 10px; border-radius: 3px; margin: 10px 0; }
        .step { background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>ğŸ” å‰ç«¯æ•°æ®æµè°ƒè¯•</h1>
    
    <div class="test-section">
        <h2>1. æ¨¡æ‹Ÿå®Œæ•´çš„æ•°æ®æµç¨‹</h2>
        <button class="test-button" onclick="simulateCompleteDataFlow()">æ¨¡æ‹Ÿå®Œæ•´æ•°æ®æµç¨‹</button>
        <div id="completeFlowResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æµ‹è¯•æ•°æ®è½¬æ¢è¿‡ç¨‹</h2>
        <button class="test-button" onclick="testDataTransformations()">æµ‹è¯•æ•°æ®è½¬æ¢</button>
        <div id="transformationResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°</h2>
        <p>è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°ï¼Œç„¶åç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</p>
        <button class="test-button" onclick="logDetailedData()">è¾“å‡ºè¯¦ç»†æ—¥å¿—åˆ°æ§åˆ¶å°</button>
        <div id="consoleResult" class="result"></div>
    </div>

    <script>
        let mockData = null;
        let processedData = null;
        
        function simulateCompleteDataFlow() {
            console.log('ğŸš€ å¼€å§‹æ¨¡æ‹Ÿå®Œæ•´æ•°æ®æµç¨‹...');
            
            // æ­¥éª¤1: æ¨¡æ‹Ÿåç«¯APIå“åº”
            console.log('æ­¥éª¤1: æ¨¡æ‹Ÿåç«¯APIå“åº”');
            mockData = {
                success: true,
                data: {
                    items: [{
                        _id: '6899364612c2294d95ab07e4',
                        name: 'é•¿å¸ˆé™„å°æ’è¯¾è§„åˆ™',
                        courseArrangementRules: {
                            fixedTimeCourses: {
                                enabled: true,
                                courses: [{
                                    type: 'class-meeting',
                                    dayOfWeek: 1,
                                    period: 1,
                                    weekType: 'all',
                                    startWeek: 1,
                                    endWeek: 20,
                                    notes: ''
                                }],
                                priority: false,
                                allowOverride: false,
                                conflictStrategy: 'strict'
                            }
                        }
                    }]
                }
            };
            
            console.log('åŸå§‹APIå“åº”:', mockData);
            
            // æ­¥éª¤2: å‰ç«¯æ¥æ”¶æ•°æ®
            console.log('æ­¥éª¤2: å‰ç«¯æ¥æ”¶æ•°æ®');
            const response = mockData;
            const schedulingRules = response.data.items;
            console.log('è§£æåçš„æ’è¯¾è§„åˆ™:', schedulingRules);
            
            // æ­¥éª¤3: è®¾ç½®åˆ°çŠ¶æ€
            console.log('æ­¥éª¤3: è®¾ç½®åˆ°çŠ¶æ€');
            processedData = schedulingRules;
            console.log('çŠ¶æ€ä¸­çš„æ’è¯¾è§„åˆ™:', processedData);
            
            // æ­¥éª¤4: ç¼–è¾‘æ—¶åŠ è½½æ•°æ®
            console.log('æ­¥éª¤4: ç¼–è¾‘æ—¶åŠ è½½æ•°æ®');
            const rules = processedData[0];
            const formData = {
                name: rules.name,
                courseArrangementRules: {
                    ...rules.courseArrangementRules,
                    fixedTimeCourses: rules.courseArrangementRules?.fixedTimeCourses || {
                        enabled: false,
                        courses: [],
                        priority: false,
                        allowOverride: false,
                        conflictStrategy: 'strict'
                    }
                }
            };
            
            console.log('è¡¨å•æ•°æ®:', formData);
            
            // æ­¥éª¤5: æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            console.log('æ­¥éª¤5: æ£€æŸ¥æ•°æ®å®Œæ•´æ€§');
            const ftc = formData.courseArrangementRules.fixedTimeCourses;
            console.log('å›ºå®šæ—¶é—´è¯¾ç¨‹é…ç½®:', ftc);
            console.log('enabled ç±»å‹:', typeof ftc.enabled);
            console.log('courses ç±»å‹:', typeof ftc.courses);
            console.log('courses æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(ftc.courses));
            console.log('courses é•¿åº¦:', ftc.courses ? ftc.courses.length : 'undefined');
            
            // æ­¥éª¤6: æ¨¡æ‹Ÿè¡¨å•æäº¤
            console.log('æ­¥éª¤6: æ¨¡æ‹Ÿè¡¨å•æäº¤');
            const submitData = { ...formData };
            console.log('æäº¤æ•°æ®:', submitData);
            
            // æ­¥éª¤7: æ£€æŸ¥æäº¤æ•°æ®çš„JSONåºåˆ—åŒ–
            console.log('æ­¥éª¤7: æ£€æŸ¥JSONåºåˆ—åŒ–');
            const jsonString = JSON.stringify(submitData);
            console.log('JSONå­—ç¬¦ä¸²:', jsonString);
            console.log('JSONå­—ç¬¦ä¸²é•¿åº¦:', jsonString.length);
            
            // æ£€æŸ¥è½¬ä¹‰å­—ç¬¦
            const escapeCount = (jsonString.match(/\\/g) || []).length;
            console.log('è½¬ä¹‰å­—ç¬¦æ•°é‡:', escapeCount);
            
            if (escapeCount > 0) {
                console.warn('âš ï¸ å‘ç°è½¬ä¹‰å­—ç¬¦ï¼Œå¯èƒ½å­˜åœ¨åºåˆ—åŒ–é—®é¢˜');
            }
            
            // æ­¥éª¤8: è§£æå›å¯¹è±¡
            console.log('æ­¥éª¤8: è§£æå›å¯¹è±¡');
            const parsedData = JSON.parse(jsonString);
            console.log('è§£æåçš„æ•°æ®:', parsedData);
            
            // æœ€ç»ˆæ£€æŸ¥
            const finalFtc = parsedData.courseArrangementRules.fixedTimeCourses;
            console.log('æœ€ç»ˆå›ºå®šæ—¶é—´è¯¾ç¨‹é…ç½®:', finalFtc);
            console.log('æœ€ç»ˆ enabled ç±»å‹:', typeof finalFtc.enabled);
            console.log('æœ€ç»ˆ courses ç±»å‹:', typeof finalFtc.courses);
            console.log('æœ€ç»ˆ courses æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(finalFtc.courses));
            
            // æ˜¾ç¤ºç»“æœ
            let resultHtml = '<div class="success">âœ… å®Œæ•´æ•°æ®æµç¨‹æ¨¡æ‹Ÿå®Œæˆ</div>';
            resultHtml += '<div class="step">æ­¥éª¤1: APIå“åº”æ•°æ®æ¥æ”¶æˆåŠŸ</div>';
            resultHtml += '<div class="step">æ­¥éª¤2: å‰ç«¯æ•°æ®è§£ææˆåŠŸ</div>';
            resultHtml += '<div class="step">æ­¥éª¤3: çŠ¶æ€è®¾ç½®æˆåŠŸ</div>';
            resultHtml += '<div class="step">æ­¥éª¤4: è¡¨å•æ•°æ®åŠ è½½æˆåŠŸ</div>';
            resultHtml += '<div class="step">æ­¥éª¤5: æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡</div>';
            resultHtml += '<div class="step">æ­¥éª¤6: è¡¨å•æäº¤æ•°æ®å‡†å¤‡å®Œæˆ</div>';
            resultHtml += '<div class="step">æ­¥éª¤7: JSONåºåˆ—åŒ–æ£€æŸ¥å®Œæˆ</div>';
            resultHtml += '<div class="step">æ­¥éª¤8: æ•°æ®è§£æéªŒè¯å®Œæˆ</div>';
            
            resultHtml += '<div class="data-display">';
            resultHtml += '<strong>æœ€ç»ˆæ•°æ®çŠ¶æ€:</strong><br>';
            resultHtml += 'enabled: ' + finalFtc.enabled + ' (ç±»å‹: ' + typeof finalFtc.enabled + ')<br>';
            resultHtml += 'courses ç±»å‹: ' + typeof finalFtc.courses + '<br>';
            resultHtml += 'courses æ˜¯å¦ä¸ºæ•°ç»„: ' + Array.isArray(finalFtc.courses) + '<br>';
            resultHtml += 'courses é•¿åº¦: ' + (finalFtc.courses ? finalFtc.courses.length : 'undefined') + '<br>';
            resultHtml += 'è½¬ä¹‰å­—ç¬¦æ•°é‡: ' + escapeCount + '<br>';
            resultHtml += '</div>';
            
            document.getElementById('completeFlowResult').innerHTML = resultHtml;
        }
        
        function testDataTransformations() {
            if (!processedData) {
                document.getElementById('transformationResult').innerHTML = '<div class="error">âŒ è¯·å…ˆæ¨¡æ‹Ÿå®Œæ•´æ•°æ®æµç¨‹</div>';
                return;
            }
            
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æ•°æ®è½¬æ¢è¿‡ç¨‹...');
            
            const originalData = processedData[0];
            const transformations = [];
            
            // æµ‹è¯•1: ç›´æ¥èµ‹å€¼
            console.log('æµ‹è¯•1: ç›´æ¥èµ‹å€¼');
            let data1 = { ...originalData };
            transformations.push({
                method: 'ç›´æ¥èµ‹å€¼ (spread operator)',
                fixedTimeCoursesType: typeof data1.courseArrangementRules.fixedTimeCourses,
                coursesType: typeof data1.courseArrangementRules.fixedTimeCourses.courses,
                coursesIsArray: Array.isArray(data1.courseArrangementRules.fixedTimeCourses.courses),
                coursesLength: data1.courseArrangementRules.fixedTimeCourses.courses ? data1.courseArrangementRules.fixedTimeCourses.courses.length : 'undefined'
            });
            
            // æµ‹è¯•2: JSONåºåˆ—åŒ–åè§£æ
            console.log('æµ‹è¯•2: JSONåºåˆ—åŒ–åè§£æ');
            let data2 = JSON.parse(JSON.stringify(originalData));
            transformations.push({
                method: 'JSONåºåˆ—åŒ–åè§£æ',
                fixedTimeCoursesType: typeof data2.courseArrangementRules.fixedTimeCourses,
                coursesType: typeof data2.courseArrangementRules.fixedTimeCourses.courses,
                coursesIsArray: Array.isArray(data2.courseArrangementRules.fixedTimeCourses.courses),
                coursesLength: data2.courseArrangementRules.fixedTimeCourses.courses ? data2.courseArrangementRules.fixedTimeCourses.courses.length : 'undefined'
            });
            
            // æµ‹è¯•3: ç»“æ„åŒ–å…‹éš†ï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (typeof structuredClone === 'function') {
                console.log('æµ‹è¯•3: structuredClone');
                let data3 = structuredClone(originalData);
                transformations.push({
                    method: 'structuredClone',
                    fixedTimeCoursesType: typeof data3.courseArrangementRules.fixedTimeCourses,
                    coursesType: typeof data3.courseArrangementRules.fixedTimeCourses.courses,
                    coursesIsArray: Array.isArray(data3.courseArrangementRules.fixedTimeCourses.courses),
                    coursesLength: data3.courseArrangementRules.fixedTimeCourses.courses ? data3.courseArrangementRules.fixedTimeCourses.courses.length : 'undefined'
                });
            }
            
            // æµ‹è¯•4: æ‰‹åŠ¨æ·±æ‹·è´
            console.log('æµ‹è¯•4: æ‰‹åŠ¨æ·±æ‹·è´');
            let data4 = JSON.parse(JSON.stringify(originalData));
            transformations.push({
                method: 'æ‰‹åŠ¨æ·±æ‹·è´ (JSON.parse + JSON.stringify)',
                fixedTimeCoursesType: typeof data4.courseArrangementRules.fixedTimeCourses,
                coursesType: typeof data4.courseArrangementRules.fixedTimeCourses.courses,
                coursesIsArray: Array.isArray(data4.courseArrangementRules.fixedTimeCourses.courses),
                coursesLength: data4.courseArrangementRules.fixedTimeCourses.courses ? data4.courseArrangementRules.fixedTimeCourses.courses.length : 'undefined'
            });
            
            // æ˜¾ç¤ºç»“æœ
            let resultHtml = '<div class="success">âœ… æ•°æ®è½¬æ¢æµ‹è¯•å®Œæˆ</div>';
            resultHtml += '<table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">';
            resultHtml += '<tr><th>è½¬æ¢æ–¹æ³•</th><th>fixedTimeCoursesç±»å‹</th><th>coursesç±»å‹</th><th>coursesæ˜¯å¦ä¸ºæ•°ç»„</th><th>coursesé•¿åº¦</th></tr>';
            
            transformations.forEach(t => {
                resultHtml += `<tr>
                    <td>${t.method}</td>
                    <td>${t.fixedTimeCoursesType}</td>
                    <td>${t.coursesType}</td>
                    <td>${t.coursesIsArray}</td>
                    <td>${t.coursesLength}</td>
                </tr>`;
            });
            
            resultHtml += '</table>';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸
            const hasIssues = transformations.some(t => !t.coursesIsArray);
            if (hasIssues) {
                resultHtml += '<div class="warning">âš ï¸ å‘ç°æ•°æ®è½¬æ¢é—®é¢˜ï¼æŸäº›æ–¹æ³•å¯¼è‡´coursesä¸å†æ˜¯æ•°ç»„</div>';
            } else {
                resultHtml += '<div class="success">âœ… æ‰€æœ‰æ•°æ®è½¬æ¢æ–¹æ³•éƒ½ä¿æŒæ•°æ®å®Œæ•´æ€§</div>';
            }
            
            document.getElementById('transformationResult').innerHTML = resultHtml;
        }
        
        function logDetailedData() {
            if (!processedData) {
                document.getElementById('consoleResult').innerHTML = '<div class="error">âŒ è¯·å…ˆæ¨¡æ‹Ÿå®Œæ•´æ•°æ®æµç¨‹</div>';
                return;
            }
            
            console.log('ğŸ“Š è¯¦ç»†æ•°æ®æ—¥å¿—å¼€å§‹ ====================');
            
            const originalData = processedData[0];
            console.log('åŸå§‹æ•°æ®:', originalData);
            
            const ftc = originalData.courseArrangementRules.fixedTimeCourses;
            console.log('å›ºå®šæ—¶é—´è¯¾ç¨‹é…ç½®:', ftc);
            console.log('å›ºå®šæ—¶é—´è¯¾ç¨‹é…ç½®ç±»å‹:', typeof ftc);
            console.log('å›ºå®šæ—¶é—´è¯¾ç¨‹é…ç½®æ„é€ å‡½æ•°:', ftc.constructor.name);
            
            console.log('courseså­—æ®µ:', ftc.courses);
            console.log('courseså­—æ®µç±»å‹:', typeof ftc.courses);
            console.log('courseså­—æ®µæ„é€ å‡½æ•°:', ftc.courses.constructor.name);
            console.log('coursesæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(ftc.courses));
            console.log('coursesé•¿åº¦:', ftc.courses.length);
            
            // æ£€æŸ¥æ¯ä¸ªè¯¾ç¨‹å¯¹è±¡
            ftc.courses.forEach((course, index) => {
                console.log(`è¯¾ç¨‹ ${index + 1}:`, course);
                console.log(`è¯¾ç¨‹ ${index + 1} ç±»å‹:`, typeof course);
                console.log(`è¯¾ç¨‹ ${index + 1} æ„é€ å‡½æ•°:`, course.constructor.name);
                console.log(`è¯¾ç¨‹ ${index + 1} å±æ€§:`, Object.keys(course));
            });
            
            // æ£€æŸ¥JSONåºåˆ—åŒ–
            console.log('JSONåºåˆ—åŒ–æµ‹è¯•:');
            const jsonString = JSON.stringify(ftc);
            console.log('JSONå­—ç¬¦ä¸²:', jsonString);
            console.log('JSONå­—ç¬¦ä¸²é•¿åº¦:', jsonString.length);
            
            // æ£€æŸ¥è½¬ä¹‰å­—ç¬¦
            const escapeCount = (jsonString.match(/\\/g) || []).length;
            console.log('è½¬ä¹‰å­—ç¬¦æ•°é‡:', escapeCount);
            console.log('è½¬ä¹‰å­—ç¬¦ä½ç½®:', [...jsonString.matchAll(/\\/g)].map(m => m.index));
            
            // è§£æå›å¯¹è±¡
            try {
                const parsed = JSON.parse(jsonString);
                console.log('è§£æåçš„å¯¹è±¡:', parsed);
                console.log('è§£æåcoursesç±»å‹:', typeof parsed.courses);
                console.log('è§£æåcoursesæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(parsed.courses));
            } catch (error) {
                console.error('JSONè§£æå¤±è´¥:', error);
            }
            
            console.log('ğŸ“Š è¯¦ç»†æ•°æ®æ—¥å¿—ç»“æŸ ====================');
            
            document.getElementById('consoleResult').innerHTML = '<div class="success">âœ… è¯¦ç»†æ—¥å¿—å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·</div>';
        }
    </script>
</body>
</html>
