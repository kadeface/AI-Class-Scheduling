<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’è¯¾è§„åˆ™è°ƒè¯•å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .section h3 { 
            margin-top: 0; 
            color: #333; 
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background: #0056b3; 
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            max-height: 300px; 
        }
        .rules-list {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        .rule-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .stat-item {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ’è¯¾è§„åˆ™è°ƒè¯•å·¥å…·</h1>
    <p>ç”¨äºè¯Šæ–­æ’è¯¾è§„åˆ™åˆ›å»ºå’Œæ˜¾ç¤ºé—®é¢˜</p>

    <!-- è¿æ¥æµ‹è¯• -->
    <div class="section">
        <h3>1. ğŸ“¡ è¿æ¥æµ‹è¯•</h3>
        <button onclick="testConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <div id="connection-result"></div>
    </div>

    <!-- åˆ—è¡¨æŸ¥è¯¢ -->
    <div class="section">
        <h3>2. ğŸ“‹ åˆ—è¡¨æŸ¥è¯¢</h3>
        <button onclick="getRulesList()">è·å–æ’è¯¾è§„åˆ™åˆ—è¡¨</button>
        <button onclick="getRulesListWithParams()">å¸¦å‚æ•°æŸ¥è¯¢</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        
        <div class="stats" id="rules-stats"></div>
        <div id="rules-result"></div>
    </div>

    <!-- åˆ›å»ºæµ‹è¯• -->
    <div class="section">
        <h3>3. âœ¨ åˆ›å»ºæµ‹è¯•</h3>
        <button onclick="createTestRule()">åˆ›å»ºæµ‹è¯•è§„åˆ™</button>
        <button onclick="createAndRefresh()">åˆ›å»ºå¹¶åˆ·æ–°åˆ—è¡¨</button>
        <div id="create-result"></div>
    </div>

    <!-- å®Œæ•´æµç¨‹æµ‹è¯• -->
    <div class="section">
        <h3>4. ğŸ§ª å®Œæ•´æµç¨‹æµ‹è¯•</h3>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="full-test-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let rulesList = [];

        function showResult(elementId, type, message, data = null) {
            const element = document.getElementById(elementId);
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸' };
            
            element.innerHTML = `
                <div class="result ${type}">
                    ${icons[type] || 'â„¹ï¸'} ${message}
                    ${data ? `<pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>` : ''}
                </div>
            `;
        }

        function updateStats(total = 0, filtered = 0) {
            const statsElement = document.getElementById('rules-stats');
            statsElement.innerHTML = `
                <div class="stat-item">
                    <strong>${total}</strong><br>æ€»è§„åˆ™æ•°
                </div>
                <div class="stat-item">
                    <strong>${filtered}</strong><br>å½“å‰æ˜¾ç¤º
                </div>
                <div class="stat-item">
                    <strong>${new Date().toLocaleTimeString()}</strong><br>æœ€åæ›´æ–°
                </div>
            `;
        }

        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('connection-result', 'success', 'åç«¯è¿æ¥æ­£å¸¸', data);
                } else {
                    showResult('connection-result', 'error', `è¿æ¥å¼‚å¸¸: ${response.status}`);
                }
            } catch (error) {
                showResult('connection-result', 'error', `è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        async function getRulesList() {
            try {
                const response = await fetch(`${API_BASE}/api/scheduling-rules`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    rulesList = data.data.items || [];
                    updateStats(data.data.total, rulesList.length);
                    
                    if (rulesList.length > 0) {
                        const listHtml = rulesList.map((rule, index) => `
                            <div class="rule-item">
                                <strong>${index + 1}. ${rule.name}</strong><br>
                                <small>å­¦å¹´: ${rule.academicYear} | å­¦æœŸ: ${rule.semester} | ç±»å‹: ${rule.schoolType}</small><br>
                                <small>åˆ›å»º: ${new Date(rule.createdAt).toLocaleString()}</small>
                            </div>
                        `).join('');
                        
                        document.getElementById('rules-result').innerHTML = `
                            <div class="result success">
                                è·å–æˆåŠŸï¼Œå…± ${rulesList.length} æ¡è§„åˆ™
                                <div class="rules-list">${listHtml}</div>
                            </div>
                        `;
                    } else {
                        showResult('rules-result', 'warning', 'è·å–æˆåŠŸï¼Œä½†åˆ—è¡¨ä¸ºç©º');
                    }
                } else {
                    showResult('rules-result', 'error', 'è·å–å¤±è´¥', data);
                }
            } catch (error) {
                showResult('rules-result', 'error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                updateStats(0, 0);
            }
        }

        async function getRulesListWithParams() {
            try {
                const params = new URLSearchParams({
                    page: 1,
                    limit: 10,
                    keyword: '',
                    academicYear: '',
                    schoolType: ''
                });
                
                const response = await fetch(`${API_BASE}/api/scheduling-rules?${params}`);
                const data = await response.json();
                
                showResult('rules-result', 'success', 'å¸¦å‚æ•°æŸ¥è¯¢ç»“æœ', data);
                
                if (data.success && data.data) {
                    updateStats(data.data.total, data.data.items?.length || 0);
                }
            } catch (error) {
                showResult('rules-result', 'error', `æŸ¥è¯¢å¤±è´¥: ${error.message}`);
            }
        }

        async function createTestRule() {
            const testData = {
                name: `è°ƒè¯•æµ‹è¯•è§„åˆ™_${new Date().toISOString().slice(0, 16)}`,
                description: 'é€šè¿‡è°ƒè¯•å·¥å…·åˆ›å»ºçš„æµ‹è¯•è§„åˆ™',
                schoolType: 'high',
                academicYear: '2024-2025',
                semester: 1,
                timeRules: {
                    dailyPeriods: 8,
                    workingDays: [1, 2, 3, 4, 5],
                    periodDuration: 45,
                    breakDuration: 10,
                    lunchBreakStart: 4,
                    lunchBreakDuration: 90,
                    morningPeriods: [1, 2, 3, 4],
                    afternoonPeriods: [5, 6, 7, 8],
                    forbiddenSlots: []
                },
                teacherConstraints: {
                    maxDailyHours: 6,
                    maxContinuousHours: 3,
                    minRestBetweenCourses: 1,
                    avoidFridayAfternoon: true,
                    respectTeacherPreferences: true,
                    allowCrossGradeTeaching: true
                },
                roomConstraints: {
                    respectCapacityLimits: true,
                    allowRoomSharing: false,
                    preferFixedClassrooms: true,
                    specialRoomPriority: 'preferred'
                },
                courseArrangementRules: {
                    allowContinuousCourses: true,
                    maxContinuousHours: 2,
                    distributionPolicy: 'balanced',
                    avoidFirstLastPeriod: [],
                    coreSubjectPriority: true,
                    labCoursePreference: 'morning'
                },
                conflictResolutionRules: {
                    teacherConflictResolution: 'strict',
                    roomConflictResolution: 'strict',
                    classConflictResolution: 'strict',
                    allowOverride: false,
                    priorityOrder: ['teacher', 'room', 'time']
                },
                isDefault: false
            };

            try {
                const response = await fetch(`${API_BASE}/api/scheduling-rules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('create-result', 'success', 'åˆ›å»ºæˆåŠŸï¼', data.data);
                } else {
                    showResult('create-result', 'error', 'åˆ›å»ºå¤±è´¥', data);
                }
            } catch (error) {
                showResult('create-result', 'error', `åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }

        async function createAndRefresh() {
            // è®°å½•åˆ›å»ºå‰çš„æ•°é‡
            await getRulesList();
            const beforeCount = rulesList.length;
            
            // åˆ›å»ºæ–°è§„åˆ™
            await createTestRule();
            
            // ç­‰å¾…1ç§’ååˆ·æ–°
            setTimeout(async () => {
                await getRulesList();
                const afterCount = rulesList.length;
                
                const changeInfo = afterCount > beforeCount 
                    ? `âœ… æˆåŠŸï¼è§„åˆ™æ•°é‡ä» ${beforeCount} å¢åŠ åˆ° ${afterCount}`
                    : `âŒ é—®é¢˜ï¼è§„åˆ™æ•°é‡æ²¡æœ‰å˜åŒ– (${beforeCount} â†’ ${afterCount})`;
                
                showResult('create-result', afterCount > beforeCount ? 'success' : 'error', changeInfo);
            }, 1000);
        }

        async function runFullTest() {
            const results = [];
            
            // 1. æµ‹è¯•è¿æ¥
            try {
                const healthResponse = await fetch(`${API_BASE}/api/health`);
                results.push(`è¿æ¥æµ‹è¯•: ${healthResponse.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
            } catch (error) {
                results.push(`è¿æ¥æµ‹è¯•: âŒ å¤±è´¥ - ${error.message}`);
                showResult('full-test-result', 'error', 'æµ‹è¯•ç»ˆæ­¢', results.join('\n'));
                return;
            }
            
            // 2. æµ‹è¯•è·å–åˆ—è¡¨
            try {
                const listResponse = await fetch(`${API_BASE}/api/scheduling-rules`);
                const listData = await listResponse.json();
                const beforeCount = listData.success ? listData.data.total : 0;
                results.push(`åˆ—è¡¨æŸ¥è¯¢: ${listResponse.ok ? `âœ… æˆåŠŸ (${beforeCount}æ¡)` : 'âŒ å¤±è´¥'}`);
                
                // 3. æµ‹è¯•åˆ›å»º
                const testData = {
                    name: `å®Œæ•´æµ‹è¯•è§„åˆ™_${Date.now()}`,
                    description: 'å®Œæ•´æµç¨‹æµ‹è¯•',
                    schoolType: 'high',
                    academicYear: '2024-2025',
                    semester: 1,
                    timeRules: {
                        dailyPeriods: 8,
                        workingDays: [1, 2, 3, 4, 5],
                        periodDuration: 45,
                        breakDuration: 10,
                        lunchBreakStart: 4,
                        lunchBreakDuration: 90,
                        morningPeriods: [1, 2, 3, 4],
                        afternoonPeriods: [5, 6, 7, 8],
                        forbiddenSlots: []
                    },
                    teacherConstraints: {
                        maxDailyHours: 6,
                        maxContinuousHours: 3,
                        minRestBetweenCourses: 1,
                        avoidFridayAfternoon: true,
                        respectTeacherPreferences: true,
                        allowCrossGradeTeaching: true
                    },
                    roomConstraints: {
                        respectCapacityLimits: true,
                        allowRoomSharing: false,
                        preferFixedClassrooms: true,
                        specialRoomPriority: 'preferred'
                    },
                    courseArrangementRules: {
                        allowContinuousCourses: true,
                        maxContinuousHours: 2,
                        distributionPolicy: 'balanced',
                        avoidFirstLastPeriod: [],
                        coreSubjectPriority: true,
                        labCoursePreference: 'morning'
                    },
                    conflictResolutionRules: {
                        teacherConflictResolution: 'strict',
                        roomConflictResolution: 'strict',
                        classConflictResolution: 'strict',
                        allowOverride: false,
                        priorityOrder: ['teacher', 'room', 'time']
                    },
                    isDefault: false
                };
                
                const createResponse = await fetch(`${API_BASE}/api/scheduling-rules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                const createData = await createResponse.json();
                results.push(`åˆ›å»ºè§„åˆ™: ${createResponse.ok && createData.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
                
                // 4. ç­‰å¾…å¹¶é‡æ–°æŸ¥è¯¢
                await new Promise(resolve => setTimeout(resolve, 1000));
                const listResponse2 = await fetch(`${API_BASE}/api/scheduling-rules`);
                const listData2 = await listResponse2.json();
                const afterCount = listData2.success ? listData2.data.total : 0;
                
                const countChange = afterCount - beforeCount;
                results.push(`æ•°æ®éªŒè¯: ${countChange > 0 ? `âœ… æˆåŠŸå¢åŠ ${countChange}æ¡` : 'âŒ æ•°æ®æœªå¢åŠ '}`);
                
                showResult('full-test-result', countChange > 0 ? 'success' : 'error', 'å®Œæ•´æµ‹è¯•ç»“æœ', results.join('\n'));
                
            } catch (error) {
                results.push(`æµ‹è¯•å¤±è´¥: ${error.message}`);
                showResult('full-test-result', 'error', 'æµ‹è¯•å¼‚å¸¸', results.join('\n'));
            }
        }

        function clearResults() {
            ['connection-result', 'rules-result', 'create-result', 'full-test-result'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            document.getElementById('rules-stats').innerHTML = '';
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html> 